<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>AI Study Chat</title>
<style>
* { box-sizing: border-box; }
body {
  margin: 0;
  font-family: "Segoe UI", Tahoma, sans-serif;
  background: #343541;
  color: #ececf1;
  height: 100vh;
}

#container {
  display: flex;
  height: 100vh;
}

/* ===== SIDEBAR ===== */
#sidebar {
  width: 260px;
  background: #202123;
  display: flex;
  flex-direction: column;
  border-right: 1px solid #2f2f38;
}

#new-chat {
  margin: 12px;
  padding: 12px;
  border-radius: 8px;
  border: 1px solid #4d4d4f;
  background: transparent;
  color: #fff;
  cursor: pointer;
}
#new-chat:hover { background: #2a2b32; }

#conversations {
  flex: 1;
  overflow-y: auto;
  padding: 8px;
}

.conv {
  padding: 10px;
  border-radius: 8px;
  cursor: pointer;
  color: #d9d9e3;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.conv:hover { background: #2a2b32; }
.conv.active { background: #343541; }

/* ===== CHAT AREA ===== */
#chat-area {
  flex: 1;
  display: flex;
  flex-direction: column;
}

#chat {
  flex: 1;
  overflow-y: auto;
  padding: 24px;
}

.msg {
  max-width: 70%;
  margin-bottom: 14px;
  padding: 14px 22px;
  border-radius: 999px;
  line-height: 1.6;
  white-space: pre-wrap;
}

.user {
  background: #10a37f;
  margin-left: auto;
  color: #fff;
}
.ai {
  background: #444654;
  margin-right: auto;
  color: #ececf1;
}

/* ===== INPUT ===== */
#input-area {
  border-top: 1px solid #2f2f38;
  padding: 16px;
}

#input-box {
  max-width: 800px;
  margin: auto;
  display: flex;
  background: #40414f;
  border-radius: 8px;
}

#input {
  flex: 1;
  background: transparent;
  border: none;
  outline: none;
  padding: 14px;
  color: #fff;
  font-size: 15px;
}

button {
  background: transparent;
  border: none;
  color: #10a37f;
  font-size: 20px;
  padding: 0 14px;
  cursor: pointer;
}
button:hover { opacity: 0.8; }

.dots span {
  animation: blink 1.4s infinite both;
}
.dots span:nth-child(2) { animation-delay: .2s; }
.dots span:nth-child(3) { animation-delay: .4s; }
@keyframes blink {
  0% { opacity: .2; }
  20% { opacity: 1; }
  100% { opacity: .2; }
}
</style>
</head>
<body>
<div id="container">

  <div id="sidebar">
    <button id="new-chat" onclick="newChat()">+ New chat</button>
    <div id="conversations"></div>
  </div>

  <div id="chat-area">
    <div id="chat"></div>
    <div id="input-area">
      <div id="input-box">
        <input id="input" placeholder="Send a message..." />
        <button onclick="send()">âž¤</button>
        <button onclick="startVoice()">ðŸŽ¤</button>
      </div>
    </div>
  </div>
</div>

<script>
let chats = JSON.parse(localStorage.getItem("chats") || "{}")
let currentChat = localStorage.getItem("currentChat") || null
let isGenerating = false

function save() {
  localStorage.setItem("chats", JSON.stringify(chats))
  localStorage.setItem("currentChat", currentChat)
}

function renderSidebar() {
  const box = document.getElementById("conversations")
  box.innerHTML = ""
  Object.keys(chats).forEach(id => {
    const div = document.createElement("div")
    div.className = "conv" + (id === currentChat ? " active" : "")
    div.textContent = chats[id].title || "New chat"
    div.onclick = () => loadChat(id)
    box.appendChild(div)
  })
}

function renderChat() {
  const chatBox = document.getElementById("chat")
  chatBox.innerHTML = ""
  if (!currentChat) return

  chats[currentChat].messages.forEach(m => {
    const div = document.createElement("div")
    div.className = "msg " + m.role
    if (m.streaming) {
      div.innerHTML = '<span class="dots"><span>.</span><span>.</span><span>.</span></span>'
    } else {
      div.textContent = m.text
    }
    chatBox.appendChild(div)
  })
  chatBox.scrollTop = chatBox.scrollHeight
}

function newChat() {
  currentChat = crypto.randomUUID()
  chats[currentChat] = { title: "New chat", messages: [] }
  save(); renderSidebar(); renderChat()
}

function loadChat(id) {
  currentChat = id
  save(); renderSidebar(); renderChat()
}

async function send() {
  if (isGenerating || !currentChat) return

  const input = document.getElementById("input")
  const text = input.value.trim()
  if (!text) return

  isGenerating = true
  input.value = ""

  const chat = chats[currentChat]
  if (chat.messages.length === 0) chat.title = text.slice(0, 30)

  chat.messages.push({ role: "user", text })

  const aiMsg = { role: "ai", text: "", streaming: true }
  chat.messages.push(aiMsg)

  save(); renderSidebar(); renderChat()

  try {
    const res = await fetch("/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message: text, session_id: currentChat })
    })

    const data = await res.json()
    const full = data.reply || ""
    let i = 0

    aiMsg.text = ""   // âœ… Ä‘áº£m báº£o luÃ´n lÃ  string

    const timer = setInterval(() => {
      aiMsg.text += full[i] || ""
      renderChat()
      save()           // âœ… lÆ°u khi Ä‘ang streaming
      i++

      if (i >= full.length) {
        clearInterval(timer)
        aiMsg.streaming = false
        isGenerating = false
        speak(full)
        save()
        renderChat()
      }
    }, 25)

  } catch (e) {
    aiMsg.text = "Error"
    aiMsg.streaming = false
    isGenerating = false
    save(); renderChat()
  }
}


function startVoice() {
  if (isGenerating) return
  if (!('webkitSpeechRecognition' in window)) {
    alert('Voice input not supported')
    return
  }
  const r = new webkitSpeechRecognition()
  r.lang = 'en-US'
  r.onresult = e => {
    document.getElementById('input').value = e.results[0][0].transcript
    send()
  }
  r.start()
}

function speak(text) {
  if (!('speechSynthesis' in window)) return
  speechSynthesis.cancel()
  const u = new SpeechSynthesisUtterance(text)
  u.lang = 'en-US'
  speechSynthesis.speak(u)
}

if (!currentChat) newChat()
renderSidebar(); renderChat()
</script>
</body>
</html>
