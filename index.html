<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<title>AI Study Chat</title>

<style>
/* ===== GI·ªÆ NGUY√äN CSS C·ª¶A B·∫†N ===== */
* { box-sizing: border-box; }

body {
  margin: 0;
  font-family: "Segoe UI", Tahoma, sans-serif;
  background: #343541;
  color: #ececf1;
  height: 100vh;
}

#container { display: flex; height: 100vh; }

#sidebar {
  width: 260px;
  background: #202123;
  display: flex;
  flex-direction: column;
  border-right: 1px solid #2f2f38;
}

#new-chat {
  margin: 12px;
  padding: 12px;
  border-radius: 8px;
  border: 1px solid #4d4d4f;
  background: transparent;
  color: #fff;
  cursor: pointer;
}
#new-chat:hover { background: #2a2b32; }

#conversations { flex: 1; overflow-y: auto; padding: 8px; }

.conv {
  padding: 10px;
  border-radius: 8px;
  cursor: pointer;
  color: #d9d9e3;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.conv:hover { background: #2a2b32; }
.conv.active { background: #343541; }

#chat-area { flex: 1; display: flex; flex-direction: column; }

#chat {
  flex: 1;
  overflow-y: auto;
  padding: 24px;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.msg {
  max-width: 70%;
  padding: 14px 22px;
  border-radius: 999px;
  white-space: pre-wrap;
  width: fit-content;
}

.user { background: #10a37f; margin-left: auto; color: #fff; }
.ai { background: #444654; margin-right: auto; color: #ececf1; }

#input-area {
  border-top: 1px solid #2f2f38;
  padding: 16px;
}

#input-box {
  max-width: 800px;
  margin: auto;
  display: flex;
  background: #40414f;
  border-radius: 8px;
}

#input {
  flex: 1;
  background: transparent;
  border: none;
  outline: none;
  padding: 14px;
  color: #fff;
  font-size: 15px;
}

button {
  background: transparent;
  border: none;
  color: #10a37f;
  font-size: 20px;
  padding: 0 14px;
  cursor: pointer;
}
button:hover { opacity: 0.8; }
</style>
</head>

<body>
<div id="container">

  <div id="sidebar">
    <button id="new-chat" onclick="newChat()">+ New chat</button>
    <div id="conversations"></div>
  </div>

  <div id="chat-area">
    <div id="chat"></div>

    <div id="input-area">
      <div id="input-box">
        <input id="input" placeholder="Send a message..." />
        <button onclick="send()">‚û§</button>
        <button onclick="startVoice()">üé§</button>
        <button onclick="toggleVoice()" id="voiceToggle">üîä</button>
      </div>
    </div>
  </div>

</div>

<script>
/* ===== STATE ===== */
let chats = JSON.parse(localStorage.getItem("chats") || "{}")
let currentChat = localStorage.getItem("currentChat") || null
let isGenerating = false
let voiceEnabled = JSON.parse(localStorage.getItem("voiceEnabled") ?? "true")

function save() {
  localStorage.setItem("chats", JSON.stringify(chats))
  localStorage.setItem("currentChat", currentChat)
  localStorage.setItem("voiceEnabled", voiceEnabled)
}

/* ===== RENDER ===== */
function renderSidebar() {
  const box = document.getElementById("conversations")
  box.innerHTML = ""
  Object.keys(chats).forEach(id => {
    const div = document.createElement("div")
    div.className = "conv" + (id === currentChat ? " active" : "")
    div.textContent = chats[id].title || "New chat"
    div.onclick = () => loadChat(id)
    box.appendChild(div)
  })
}

function renderChat() {
  const chatBox = document.getElementById("chat")
  chatBox.innerHTML = ""
  if (!currentChat) return

  chats[currentChat].messages.forEach(m => {
    const div = document.createElement("div")
    div.className = "msg " + m.role
    div.textContent = m.text
    chatBox.appendChild(div)
  })
  chatBox.scrollTop = chatBox.scrollHeight
}

function createMessage(role) {
  const div = document.createElement("div")
  div.className = "msg " + role
  document.getElementById("chat").appendChild(div)
  document.getElementById("chat").scrollTop =
    document.getElementById("chat").scrollHeight
  return div
}

/* ===== CHAT ===== */
function newChat() {
  currentChat = crypto.randomUUID()
  chats[currentChat] = { title: "New chat", messages: [] }
  save(); renderSidebar(); renderChat()
}

function loadChat(id) {
  currentChat = id
  save(); renderSidebar(); renderChat()
}

/* ===== SEND ===== */
async function send() {
  if (isGenerating || !currentChat) return

  const input = document.getElementById("input")
  const text = input.value.trim()
  if (!text) return

  isGenerating = true
  input.value = ""

  const chat = chats[currentChat]
  if (chat.messages.length === 0) chat.title = text.slice(0, 30)

  chat.messages.push({ role: "user", text })
  save()
  renderSidebar()
  renderChat()

  const aiMsg = { role: "ai", text: "" }
  chat.messages.push(aiMsg)
  save()

  const aiDiv = createMessage("ai")

  try {
    const res = await fetch("/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message: text, session_id: currentChat })
    })

    const data = await res.json()
    streamText(aiMsg, aiDiv, data.reply || "")

  } catch {
    aiDiv.textContent = "Error"
    isGenerating = false
  }
}

/* ===== STREAMING (KH√îNG GI·∫¨T) ===== */
function streamText(aiMsg, aiDiv, fullText) {
  const words = fullText.split(/(\s+)/)
  let i = 0

  const timer = setInterval(() => {
    aiMsg.text += words[i] || ""
    aiDiv.textContent = aiMsg.text
    i++

    if (i >= words.length) {
      clearInterval(timer)
      isGenerating = false
      save()
      if (voiceEnabled) speak(fullText)
    }
  }, 35 + Math.random() * 20)
}

/* ===== VOICE INPUT ===== */
function startVoice() {
  if (isGenerating) return
  if (!('webkitSpeechRecognition' in window)) {
    alert("Voice input not supported")
    return
  }

  const r = new webkitSpeechRecognition()
  r.lang = navigator.language || "en-US"
  r.onresult = e => {
    document.getElementById("input").value = e.results[0][0].transcript
    send()
  }
  r.start()
}

/* ===== VOICE OUTPUT ===== */
function isVietnamese(text) {
  return /[√†√°·∫°·∫£√£√¢·∫ß·∫•·∫≠·∫©·∫´ƒÉ·∫±·∫Ø·∫∑·∫≥·∫µ√®√©·∫π·∫ª·∫Ω√™·ªÅ·∫ø·ªá·ªÉ·ªÖ√¨√≠·ªã·ªâƒ©√≤√≥·ªç·ªè√µ√¥·ªì·ªë·ªô·ªï·ªó∆°·ªù·ªõ·ª£·ªü·ª°√π√∫·ª•·ªß≈©∆∞·ª´·ª©·ª±·ª≠·ªØ·ª≥√Ω·ªµ·ª∑·ªπƒë]/i.test(text)
}

function speak(text) {
  if (!('speechSynthesis' in window)) return
  speechSynthesis.cancel()
  const u = new SpeechSynthesisUtterance(text)
  u.lang = isVietnamese(text) ? "vi-VN" : "en-US"
  speechSynthesis.speak(u)
}

/* ===== TOGGLE VOICE ===== */
function toggleVoice() {
  voiceEnabled = !voiceEnabled
  document.getElementById("voiceToggle").textContent = voiceEnabled ? "üîä" : "üîá"
  save()
}

document.getElementById("voiceToggle").textContent = voiceEnabled ? "üîä" : "üîá"

if (!currentChat) newChat()
renderSidebar(); renderChat()
</script>
</body>
</html>
