<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>AI Study Chat</title>

<style>
* { box-sizing: border-box; }

body {
  margin: 0;
  font-family: system-ui, sans-serif;
  background: #343541;
  color: #ececf1;
  height: 100vh;
}

#container {
  display: flex;
  height: 100vh;
}

/* SIDEBAR */
#sidebar {
  width: 260px;
  background: #202123;
  border-right: 1px solid #2f2f38;
  display: flex;
  flex-direction: column;
}

#new-chat {
  margin: 12px;
  padding: 10px;
  border: 1px solid #555;
  border-radius: 6px;
  background: transparent;
  color: white;
  cursor: pointer;
}

#conversations {
  flex: 1;
  overflow-y: auto;
}

.conv {
  padding: 10px;
  cursor: pointer;
}
.conv:hover { background: #2a2b32; }
.conv.active { background: #343541; }

/* CHAT */
#chat-area {
  flex: 1;
  display: flex;
  flex-direction: column;
}

#chat {
  flex: 1;
  overflow-y: auto;
  padding: 24px;
}

.msg {
  max-width: 900px;
  margin-bottom: 16px;
  padding: 16px 20px;
  border-radius: 6px;
  line-height: 1.6;
  white-space: pre-wrap;
}

.user {
  background: #10a37f;
  margin-left: auto;
  color: white;
}

.ai {
  background: #444654;
  margin-right: auto;
}

/* INPUT */
#input-area {
  border-top: 1px solid #2f2f38;
  padding: 12px;
}

#input-box {
  display: flex;
  max-width: 900px;
  margin: auto;
  background: #40414f;
  border-radius: 6px;
}

#input {
  flex: 1;
  padding: 14px;
  border: none;
  background: transparent;
  color: white;
  outline: none;
}

button {
  background: none;
  border: none;
  color: #10a37f;
  font-size: 18px;
  padding: 0 12px;
  cursor: pointer;
}

.dots span {
  animation: blink 1.4s infinite both;
}
@keyframes blink {
  0% {opacity:.2}
  20% {opacity:1}
  100% {opacity:.2}
}
</style>
</head>

<body>
<div id="container">

<div id="sidebar">
  <button id="new-chat" onclick="newChat()">+ New chat</button>
  <div id="conversations"></div>
</div>

<div id="chat-area">
  <div id="chat"></div>

  <div id="input-area">
    <div id="input-box">
      <input id="input" placeholder="Nháº­p tin nháº¯n..." />
      <button onclick="send()">âž¤</button>
      <button onclick="startVoice()">ðŸŽ¤</button>
      <button onclick="toggleVoice()" id="voiceToggle">ðŸ”Š</button>
    </div>
  </div>
</div>

</div>

<script>
let chats = JSON.parse(localStorage.getItem("chats") || "{}")
let currentChat = localStorage.getItem("currentChat")
let isGenerating = false
let voiceEnabled = JSON.parse(localStorage.getItem("voiceEnabled") ?? "true")

function save() {
  localStorage.setItem("chats", JSON.stringify(chats))
  localStorage.setItem("currentChat", currentChat)
  localStorage.setItem("voiceEnabled", voiceEnabled)
}

/* UI */
function renderSidebar() {
  const box = document.getElementById("conversations")
  box.innerHTML = ""
  Object.keys(chats).forEach(id => {
    const d = document.createElement("div")
    d.className = "conv" + (id === currentChat ? " active" : "")
    d.textContent = chats[id].title || "New chat"
    d.onclick = () => loadChat(id)
    box.appendChild(d)
  })
}

function renderChat() {
  const box = document.getElementById("chat")
  box.innerHTML = ""
  if (!currentChat) return

  chats[currentChat].messages.forEach(m => {
    const div = document.createElement("div")
    div.className = "msg " + m.role
    div.textContent = m.text || "..."
    box.appendChild(div)
  })
  box.scrollTop = box.scrollHeight
}

function newChat() {
  currentChat = crypto.randomUUID()
  chats[currentChat] = { title: "New chat", messages: [] }
  save(); renderSidebar(); renderChat()
}

function loadChat(id) {
  currentChat = id
  save(); renderSidebar(); renderChat()
}

/* STREAMING MÆ¯á»¢T */
function streamText(aiMsg, text) {
  const words = text.split(/(\s+)/)
  let i = 0
  function step() {
    if (i < words.length) {
      aiMsg.text += words[i++]
      renderChat()
      requestAnimationFrame(step)
    } else {
      isGenerating = false
      if (voiceEnabled) speak(text)
      save()
    }
  }
  step()
}

/* SEND */
async function send() {
  if (isGenerating) return
  const input = document.getElementById("input")
  const text = input.value.trim()
  if (!text) return

  isGenerating = true
  input.value = ""

  const chat = chats[currentChat]
  if (!chat.title) chat.title = text.slice(0, 30)

  chat.messages.push({ role: "user", text })
  const aiMsg = { role: "ai", text: "" }
  chat.messages.push(aiMsg)

  renderChat(); save()

  const res = await fetch("/chat", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ session_id: currentChat, message: text })
  })

  const data = await res.json()
  streamText(aiMsg, data.reply || "")
}

/* VOICE INPUT */
function startVoice() {
  if (!('webkitSpeechRecognition' in window)) return alert("KhÃ´ng há»— trá»£ voice")
  const r = new webkitSpeechRecognition()
  r.lang = "vi-VN"
  r.onresult = e => {
    document.getElementById("input").value = e.results[0][0].transcript
    send()
  }
  r.start()
}

/* VOICE OUTPUT */
function isVietnamese(t) {
  return /[Ã Ã¡áº¡áº£Ã£Ã¢ÄƒÃªÃ´Æ¡Æ°Ä‘]/i.test(t)
}

function speak(text) {
  speechSynthesis.cancel()
  const u = new SpeechSynthesisUtterance(text)
  u.lang = isVietnamese(text) ? "vi-VN" : "en-US"
  speechSynthesis.speak(u)
}

function toggleVoice() {
  voiceEnabled = !voiceEnabled
  document.getElementById("voiceToggle").textContent = voiceEnabled ? "ðŸ”Š" : "ðŸ”‡"
  save()
}

/* INIT */
if (!currentChat) newChat()
document.getElementById("voiceToggle").textContent = voiceEnabled ? "ðŸ”Š" : "ðŸ”‡"
renderSidebar(); renderChat()
</script>
</body>
</html>
